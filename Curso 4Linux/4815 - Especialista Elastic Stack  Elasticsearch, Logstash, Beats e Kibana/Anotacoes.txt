Anotações Curso Especialista Elastic Stack
==========================================

Instrutor: Rodrigo Tornis
Curso....: 4815
Turma....: 

# Verificando se as portas utilizadas pelo Elastic estão escutando
    netstat -nltp |grep 9[23]00

# Desabilitando IPV6
vim /etc/sysctl.conf
    net.ipv6.conf.all.disable_ipv6 = 1 
    net.ipv6.conf.default.disable_ipv6 = 1

# Diretório de Configurações do Elastic
    /etc/elasticsearch/

# Verificnaod informações do Cluster
    curl -X GET http://localhost:9200
    {
    "name" : "81stxHx",
    "cluster_name" : "elasticsearch",
    "cluster_uuid" : "6mhqvD4GSKa8PV7WToqPeA",
    "version" : {
        "number" : "6.3.1",
        "build_flavor" : "default",
        "build_type" : "rpm",
        "build_hash" : "eb782d0",
        "build_date" : "2018-06-29T21:59:26.107521Z",
        "build_snapshot" : false,
        "lucene_version" : "7.3.1",
        "minimum_wire_compatibility_version" : "5.6.0",
        "minimum_index_compatibility_version" : "5.0.0"
    },
    "tagline" : "You Know, for Search"
    }

    minimum_wire_compatibility_version  > Menor versão necessária para upgrade dos binários
    minimum_index_compatibility_version > Menor versão necessária para upgrade dos índices

informações importantes para ambiente produtivo
===============================================
- Matriz de compatibilidade dos produtos Elastic - https://www.elastic.co/pt/support/matrix
- Itens a serem verificados para montar um ambiente Elastic de produção - https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html
- Recomendação mínima de 3 nós para o cluster, suficiente capaz de suportar a carga que o Elastic vai atender
- Melhor escalar horizontal (mais nós no cluster) devido a limitações de Kernel (filedescriptor) e memória utilizada pelo Elastic (máximo 32Gb para JavaHeap sendo ideal o host ter o dobro de memória Heap utilizado)
- Não deve ter memória swap (deve ser Desabilitado)
- Aumentar descriptor de arquivos para usuário elasticsearch em /etc/security/limits.conf
    elasticsearch    -       nofile          65536
- Ajustar parametro de kernel /etc/sysctl.conf
    vm.max_map_count = 262144
- Ajustar arquivo de configuração Elastic /etc/elasticsearch/elasticsearch.yml
    cluster.name: <nome_cluster>
    node.name: <nome_do_no>
    path.data: <diretorio_armazenamento_index>
    path.logs: <diretorio_armazenamento_logs>
    network.host: <ip_interface_rede>
    http.port: 9200
    discovery.seed_hosts: ["<IPs_NOS_MASTER"] 
    cluster.initial_master_nodes: ["<IP_PRIMEIRO_NO_CRIADO>"]

Após Clonar para criar novos nós
================================
- parar serviço elasticsearch
- excluir indices antigos
    rm -rf /var/lib/elasticsearch/*
- alterar
    node.name
    network.host
    discovery.seed_hosts
    comentar "cluster.initial_master_nodes"


Definições dos membros do cluster Elastic
=========================================
Master
- node.master configurado para true
- responsável por criar e excluir um index
- rastrear quais nós fazem parte do cluster
- gerenciar quais shards são alocados em quais nós
- importante para garantir integridade do cluster que tenha apenas um único master eleito

Data node
- node.data configurado para true
- Contém de fato o dado armazenado em shards
- Realiza operações de indexação, pesquisa e agregações
- Fazem uso intensivo de IO, memória e CPU

Cliente node (coordinating node)
- Ajustar os parâmetros node.master, node.data e node.ingest para false
- Rotear as requisições para os Data Nodes funcionando como um balanceador inteligente
- Usado em cluster com muitos Data Nodes 

Ingest node
- node.ingest configurado para true
- Executar pipelines para o tratamento de documentos
- Usado para transformações simples para uma alta carga de ingestão

Definições 
=========================================

Shards e Replicas
- Fragmentos do dado
- Equalizar, subdividir e replicar dado e não sobrecarregar uma única máquina
- Replicas são para garantir mecanismo de failover em caso de falha em algum shard
- Instâncias do Lucene onde de fato é armazenado o dado
- Menor fragmento dentro do Cluster Elastic

Index
- Nome lógico para os Shards
- Estrutura que contém os diversos Types
- Analogia a um Database
- Pode particionar um indice por tempo, tamanho ou qualquer outro modelo

Type
- Estrutura que contem uma mesma classe de documentos
- Possui um mapeamento que descreve os campos e seu tipo dentro de um indice e como esses campos devem ser indexados pelo Lucene
- Definir corretamente o mapeamento de um Type faz toda diferença na performance do cluster
- Analogia a uma tabela


Trabalhando com Indices e documentos
====================================

Criando "meu_indice"
$ curl -X PUT http://localhost:9200/meu_indice?pretty

Consultando "meu_indice"
$ curl -X GET http://localhost:9200/meu_indice?pretty

Removendo "meu_indice"
$ curl -X DELETE http://localhost:9200/meu_indice?pretty

Inserindo "documento" no "meu_indice"
$ curl -X PUT http://localhost:9200/meu_indice/tipo/documento?pretty -H 'Content-Type: application/json' -d "{ \"chave\": \"valor\"}"

Atualizando "documento" no "meu_indice"
$ curl -X PUT http://localhost:9200/meu_indice/tipo/documento?pretty -H 'Content-Type: application/json' -d "{ \"chave\": \"valor\"}"

Consultando "documento" no "meu_indice"
$ curl -X GET http://localhost:9200/meu_indice/_search?pretty -H 'Content-Type: application/json' -d "{ \"query\": { \"match\" : { \"chave\": \"valor\"}}}"

Excluindo "documento" no "meu_indice"
$ curl -X DELETE http://localhost:9200/meu_indice/tipo/documento?pretty

Alterando configuração do "meu_indice"
$ curl -X PUT http://localhost:9200/meu_indice/_settings -H 'Content-Type: application/json' -d '{"number_of_replicas": 0}'


Mapping
=======
- Definir os tipos de campo e como serão armazenados
- Consultando mapeamento de um index
    $ curl -X GET http://localhost:9200/meu_indice/_mapping


* Open Distro - Amazon
======================
curl http://192.168.0.150:9200/_cat/indices?v

_refresh (custoso)

https://github.com/tornis/elastic
https://t.me/joinchat/CaNRUUG75508QzdtbB9vtg